# WZ工作流迁移系统 - VPN环境启动脚本

## 📋 概述

本文档介绍了为VPN环境专门设计的自动化启动脚本，用于在需要VPN连接的工作环境中快速启动WZ工作流迁移系统的前后端服务。

## 🎯 功能特性

### 🔧 核心功能
- ✅ 自动获取当前公网IP地址
- ✅ 验证本地IP为192.168.0.100
- ✅ 自动配置前后端服务的VPN模式
- ✅ 智能端口检测和释放
- ✅ 服务健康检查
- ✅ 一键启动和停止

### 🌟 高级功能
- 📊 实时状态监控
- 🔄 多重备用IP获取服务
- 📝 详细的启动日志
- ⚙️ 动态环境配置生成
- 🛡️ 网络连接验证

## 📁 脚本文件说明

### 主要脚本

| 文件名 | 描述 | 推荐使用场景 |
|--------|------|-------------|
| `start-vpn-environment.bat` | 基础VPN启动脚本 | 简单环境，快速启动 |
| `start-vpn-advanced.bat` | 高级VPN启动脚本 | 复杂环境，需要详细监控 |
| `stop-vpn-environment.bat` | 统一停止脚本 | 停止所有相关服务 |

### 辅助工具

| 文件名 | 描述 |
|--------|------|
| `utils/get-public-ip.ps1` | PowerShell公网IP获取工具 |
| `.vpn-status.json` | 服务状态文件（自动生成） |

## 🚀 使用方法

### 1. 环境准备

确保您的系统满足以下要求：

```bash
# 必需软件
- Windows 10/11
- Node.js (v16或更高版本)
- npm 或 yarn
- PowerShell 5.0+（高级模式需要）

# 网络配置
- 本地IP地址: 192.168.0.100
- VPN连接: 已建立并正常工作
- 防火墙: 允许端口 3001 和 5173
```

### 2. 快速启动

#### 方式一：基础启动（推荐新手）
```cmd
# 双击运行或命令行执行
start-vpn-environment.bat
```

#### 方式二：高级启动（推荐进阶用户）
```cmd
# 以管理员身份运行（推荐）
start-vpn-advanced.bat
```

### 3. 停止服务

```cmd
# 停止所有相关服务
stop-vpn-environment.bat
```

## ⚙️ 配置说明

### 自动生成的环境文件

脚本会自动生成以下配置文件：

#### 后端配置 (`backend/.env`)
```env
# VPN模式配置
PORT=3001
HOST=0.0.0.0
NODE_ENV=development
PUBLIC_IP=你的公网IP
LOCAL_IP=192.168.0.100
VPN_MODE=true
FRONTEND_URL=http://你的公网IP:5173
```

#### 前端配置 (`.env.local`)
```env
# API配置
VITE_API_BASE_URL=http://你的公网IP:3001
VITE_PUBLIC_IP=你的公网IP
VITE_LOCAL_IP=192.168.0.100
VITE_VPN_MODE=true
```

### 自定义配置

如需自定义配置，可以在启动前修改以下文件：
- `utils/get-public-ip.ps1` - IP获取服务配置
- 各脚本文件中的端口号和服务配置

## 🔍 故障排除

### 常见问题

#### 1. 无法获取公网IP
```
症状：脚本显示"无法获取公网IP地址"
解决方案：
1. 检查VPN连接是否正常
2. 确认网络防火墙设置
3. 尝试手动访问 https://ipinfo.io/ip
```

#### 2. 本地IP不是192.168.0.100
```
症状：脚本提示"本地IP地址不是192.168.0.100"
解决方案：
1. 打开网络设置
2. 修改网络适配器IP为192.168.0.100
3. 重启网络服务
```

#### 3. 端口被占用
```
症状：服务启动失败，端口冲突
解决方案：
1. 运行 stop-vpn-environment.bat
2. 手动检查端口：netstat -an | findstr ":3001\|:5173"
3. 使用管理员权限运行脚本
```

#### 4. 服务无法访问
```
症状：浏览器无法打开应用
解决方案：
1. 检查防火墙设置
2. 确认VPN状态
3. 验证公网IP是否变化
4. 重新运行启动脚本
```

### 日志查看

#### 服务状态
```cmd
# 查看当前状态
type .vpn-status.json

# 检查服务健康
curl http://你的公网IP:3001/health
```

#### 详细日志
- 后端日志：查看后端服务窗口
- 前端日志：查看前端服务窗口
- 系统日志：`logs/` 目录（如果存在）

## 🔧 高级用法

### PowerShell独立使用

```powershell
# 获取网络信息（JSON格式）
.\utils\get-public-ip.ps1 -Json -Verbose

# 仅获取IP地址
.\utils\get-public-ip.ps1
```

### 自定义启动参数

可以修改脚本中的以下变量：

```batch
:: 端口配置
set BACKEND_PORT=3001
set FRONTEND_PORT=5173

:: 超时设置
set STARTUP_TIMEOUT=10
set HEALTH_CHECK_TIMEOUT=5
```

## 📊 性能优化

### 建议配置

1. **系统资源**
   - 内存：建议8GB以上
   - CPU：双核以上
   - 硬盘：SSD推荐

2. **网络配置**
   - VPN稳定性：确保VPN连接稳定
   - 带宽：建议10Mbps以上
   - 延迟：控制在100ms以内

3. **开发环境**
   - Node.js：使用LTS版本
   - npm：保持最新版本
   - 依赖缓存：定期清理node_modules

## 🔒 安全注意事项

1. **网络安全**
   - 仅在受信任的VPN环境中使用
   - 定期更新VPN客户端
   - 避免在公共网络中暴露服务

2. **访问控制**
   - 确保只有授权用户能访问服务
   - 考虑添加额外的身份验证
   - 监控异常访问尝试

3. **数据保护**
   - 定期备份数据库
   - 使用HTTPS（生产环境）
   - 保护敏感配置信息

## 🆘 支持与反馈

如果您在使用过程中遇到问题：

1. 首先查看本文档的故障排除部分
2. 检查系统事件日志
3. 收集相关错误信息和日志
4. 联系技术支持团队

## 📝 更新日志

### v2.0 (当前版本)
- ✅ 新增高级启动脚本
- ✅ 添加PowerShell支持
- ✅ 增强错误处理
- ✅ 改进状态监控

### v1.0
- ✅ 基础VPN启动功能
- ✅ 自动IP获取
- ✅ 环境配置生成

---

**注意：** 本脚本专为WZ工作流迁移系统的VPN环境设计，请确保在正确的网络环境中使用。
