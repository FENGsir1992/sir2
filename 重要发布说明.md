# 重要发布说明（原子发布 + 多版本回滚）

本文档说明：从本地开发推送代码，到服务器原子发布与回滚的完整步骤。请严格按照步骤操作。

---

## 一、整体流程（速览）

本地（唯一源码真相）→ 推送到 GitHub 仓库 → 服务器执行部署脚本 → Nginx/PM2 自动切换到新版本。

- 仓库地址（SSH）：`git@github.com:FENGsir1992/sir2.git`
- 服务器部署脚本：`/usr/local/bin/deploy-jr.sh`
- 服务器回滚脚本：`/usr/local/bin/rollback-jr.sh`
- 站点根目录（Nginx root）：`/www/wwwroot/jr-app/current/dist`
- 共享资源目录：`/www/wwwroot/jr-app/shared/backend/{env.local, certs, uploads, logs, data}`
- 后端进程（PM2）：`jr-backend`

> 注：`current` 是符号链接，始终指向最新一次成功发布的版本目录（`/www/wwwroot/jr-app/releases/<时间戳>`）。

---

## 二、本地开发提交与推送

1) 确保 Node 版本为 20.x（推荐使用 nvm 管理并锁定）。
2) 前端 `.env.production` 内容（已创建）：

```env
VITE_API_BASE_URL=/api
VITE_VPN_MODE=false
```

3) `.gitignore` 必须排除以下内容（已创建）：

```
node_modules/
dist/
logs/
*.log
*.tgz
.env.local
.env.*.local
backend/data/
backend/logs/
backend/uploads/
backend/certs/
backend/env.local
cloudflared.exe
cpolar.exe
ngrok.exe
```

4) 提交与推送（PowerShell 在项目根执行）：

```powershell
git add -A
git commit -m "feat: update"
git push -u origin main
```

> 如果使用 SSH：需在 GitHub“Settings → SSH and GPG keys”添加本机公钥。

---

## 三、服务器原子发布（标准步骤）

1) SSH 登录服务器，执行部署脚本：

```bash
/usr/local/bin/deploy-jr.sh
```

部署脚本会自动执行：
- 克隆/拉取最新代码到 `/www/wwwroot/jr-app-repo`
- 前端：`npm ci && npm run build`
- 后端：`npm ci && npm run build`（完整依赖用于通过类型检查/编译）
- 复制 `backend/node_modules` 与 `dist` 到发布包，切换 `current` 后在 `current/backend` 执行 `npm prune --omit=dev` 精简为运行时依赖
- 组装新发布目录 `/www/wwwroot/jr-app/releases/<时间戳>` 并链接共享资源：`env.local/certs/uploads/logs/data`
- 切换 `current` 指向新发布目录
- `pm2 start|restart jr-backend`、`nginx -t && nginx -s reload`

2) 检查健康：

```bash
curl -I https://www.jiruikeji.top/health  # 期望 200
```

> 首次接入时，请把 Nginx 站点 root 固定为：`/www/wwwroot/jr-app/current/dist`。

---

## 四、回滚（上一发布版本）

如果新版本异常，可一键回滚到上一个成功的发布版本：

```bash
/usr/local/bin/rollback-jr.sh
```

脚本会执行：
- 将 `current` 符号链接切回上一个时间戳目录
- `pm2 restart jr-backend`
- `nginx -t && nginx -s reload`

> 说明：回滚脚本会在切换后等待本地/域名健康 200（最长约 120 秒）。窗口期如出现 000/502 属正常现象，脚本会自动重试直至健康或超时。

---

## 五、环境变更与证书更换

若仅修改后端环境或证书，无需重新构建：

1) 修改共享目录下的环境/证书：

```bash
vi /www/wwwroot/jr-app/shared/backend/env.local
# 或替换 certs 文件
```

2) 重启后端：

```bash
pm2 restart jr-backend
```

> 上传文件、日志、数据库（SQLite）均在 shared 下的 `uploads/logs/data`，版本切换不会丢失。

---

## 六、常见问题与处理

1) 部署时 npm 镜像 404（如 `simple-swizzle`）：

```bash
export npm_config_registry=https://registry.npmjs.org
/usr/local/bin/deploy-jr.sh
```

或永久切换：`npm config set registry https://registry.npmjs.org`

2) 后端未启动/端口未监听：

```bash
pm2 status
pm2 logs jr-backend --lines 100
```

3) 健康检查失败：

确认 `current` 指向的版本目录存在，Nginx 已重载，`env.local` 配置正确；必要时执行回滚脚本。

---

## 七、目录结构（参考）

```
/www/wwwroot/jr-app
 ├─ releases/                 # 每次发布的时间戳目录
 ├─ current  -> releases/xxxx # 当前生效版本（符号链接）
 └─ shared/
     └─ backend/
         ├─ env.local
         ├─ certs/
         ├─ uploads/
         ├─ logs/
         └─ data/

/www/wwwroot/jr-app-repo      # 纯代码仓库工作区（不直接对外）
```

---

## 八、发布与回滚命令清单（可复制）

```bash
# 发布
/usr/local/bin/deploy-jr.sh

# 拉取最新并立即发布（推荐日常）
/usr/local/bin/publish-latest.sh

# 回滚
/usr/local/bin/rollback-jr.sh

# 健康检查
curl -I https://www.jiruikeji.top/health

# 后端重启
pm2 restart jr-backend
```

---

如需扩展：CDN 缓存刷新、灰度发布、发布后自动验证等，请联系维护者补充到脚本。

---

## 九、固定的 Nginx server 配置块（复制粘贴）

将你的站点配置为如下（注意替换证书路径为你的实际路径）：

```nginx
server {
    listen 80;
    server_name www.jiruikeji.top jiruikeji.top;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl http2;
    server_name www.jiruikeji.top jiruikeji.top;

    ssl_certificate     /www/server/panel/vhost/cert/www.jiruikeji.top/fullchain.pem;
    ssl_certificate_key /www/server/panel/vhost/cert/www.jiruikeji.top/privkey.pem;

    # 前端构建产物（原子发布：指向 current/dist）
    root  /www/wwwroot/jr-app/current/dist;
    index index.html;

    # 证书申请验证目录（宝塔会自动 include）
    include /www/server/panel/vhost/nginx/well-known/www.jiruikeji.top.conf;

    # SPA 路由
    location / {
        try_files $uri $uri/ /index.html;
        index index.html;
    }

    # 后端 API 反代
    location ^~ /api/ {
        proxy_pass http://127.0.0.1:3001;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        client_max_body_size 10m;
    }

    # 上传静态（由后端控制缓存/跨域策略，故仍走后端）
    location ^~ /uploads/ {
        proxy_pass http://127.0.0.1:3001;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Proto https;
    }

    # 健康检查
    location = /health {
        proxy_pass http://127.0.0.1:3001/health;
    }
}
```

应用后执行：

```bash
nginx -t && nginx -s reload
```

也可使用项目内脚本自动切换 root 并备份配置：

```bash
cp /www/wwwroot/jr-app/current/scripts/nginx-switch-root.sh /usr/local/bin/nginx-switch-root.sh
chmod +x /usr/local/bin/nginx-switch-root.sh
/usr/local/bin/nginx-switch-root.sh
```

---

## 十、自动化验证脚本（服务器）

已提供脚本：`scripts/verify-release.sh`（项目内）。将其上传/复制到服务器并执行，或直接参考其中命令：

```bash
bash scripts/verify-release.sh
```

脚本检查项：
- 健康检查 200
- `current` 符号链接是否指向 `releases/时间戳`
- Nginx 是否使用 `root /www/wwwroot/jr-app/current/dist`
- PM2 `jr-backend` 是否 online

---

## 十一、部署脚本（自动触发验证）

服务器已固定以下脚本（无需从仓库复制）：

```bash
# 入口：发布（带健康门禁/自动回滚，可接入钉钉通知）
/usr/local/bin/deploy-jr.sh

# 核心发布逻辑（仅构建/切换，不通知）
/usr/local/bin/deploy-core.sh

# 拉取最新并立即发布（推荐日常）
/usr/local/bin/publish-latest.sh
```

脚本会自动完成：
- 拉取代码 → 前后端构建 → 复制 `backend/node_modules/dist` → 切换 `current` → 在 `current/backend` 执行 `npm prune --omit=dev` → PM2 重启 → Nginx reload
- 自动打印健康检查结果（本地与域名）
- 清理历史（仅保留最近 5 个版本）


---

## 十二、发布流程固化与运维要点（2025-09-20 修订）

为避免再次出现“构建通过但发布后 502/404、后端未监听、健康检查不稳定”等问题，已对脚本和配置进行标准化，日常只需按下列步骤操作。

### A. 服务器日常发布（简版）

```bash
# 一键拉取最新并发布（推荐）
/usr/local/bin/publish-latest.sh

# 或仅发布（不拉取）
/usr/local/bin/deploy-jr.sh
```

说明：
- 脚本会先等待本地健康 `http://127.0.0.1:3001/health` 变为 200，再对域名 `https://www.jiruikeji.top/health` 做最长约 120 秒重试；若仍失败，自动回滚到上一个成功版本，并退出非零。
- 后端以 `--cwd /www/wwwroot/jr-app/current/backend` 启动，避免读取错误目录；发布包内包含 `backend/node_modules`，不会因依赖缺失报错。

### B. 回滚（上一成功版本）

```bash
/usr/local/bin/rollback-jr.sh
```

回滚会：将 `current` 指回上一个 `releases/时间戳` 目录 → 重启 `pm2 jr-backend`（更新 env）→ `nginx -t && nginx -s reload`。

若需通知/自动化：
- 可设置环境变量 `JR_NOTIFY_URL`（一个可接收 JSON 的 HTTP 接口），部署脚本会在成功/失败/回滚时 POST：
  ```json
  { "status": "success|rolled_back|failed", "release": "/www/wwwroot/jr-app/releases/<ts>", "time": "2025-09-20T03:40:00+08:00", "message": "..." }
  ```
  注意：接口不可阻塞（超时 5s 内返回即可）。

### B+. 通知配置（钉钉加签）

- 设置环境变量（建议写入 `/etc/profile.d/jr-notify.sh`）：
  - `JR_NOTIFY_URL`：钉钉机器人 Webhook
  - `JR_NOTIFY_DING_SECRET`：加签密钥
- 自检（期望返回 `{"errcode":0,"errmsg":"ok"}` 并在钉钉收到“JR通知连通性测试”）：
  ```bash
  ts=$(( $(date +%s) * 1000 ))
  str="${ts}\n${JR_NOTIFY_DING_SECRET}"
  sig=$(printf "%b" "$str" | openssl dgst -sha256 -hmac "$JR_NOTIFY_DING_SECRET" -binary | openssl base64 -A)
  sig=${sig//+/%2B}; sig=${sig//\//%2F}; sig=${sig//=/%3D}
  curl -sS "${JR_NOTIFY_URL}&timestamp=${ts}&sign=${sig}" \
    -H 'Content-Type: application/json' \
    -d '{"msgtype":"text","text":{"content":"JR通知连通性测试"}}'
  ```
- 常见错误：`errcode=310000` 为签名不匹配，请检查“安全设置=加签”、密钥无空格、时间戳为当前时间（允许 ±1 小时）。

### C. 服务器一次性准备（若尚未完成）

- Node 版本：使用 nvm 安装并锁定 20.x（脚本与项目均要求 ≥20）
  ```bash
  curl -fsSL https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash
  export NVM_DIR="$HOME/.nvm"; [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
  nvm install 20 && nvm alias default 20 && nvm use 20
  ```
- 进程守护：
  ```bash
  npm i -g pm2 --registry=https://registry.npmmirror.com
  pm2 save && pm2 startup   # 按提示执行 systemd 命令
  ```
- Nginx 站点（关键项，已在正文第九节给出完整示例）：
  - `root  /www/wwwroot/jr-app/current/dist;`
  - `location / { try_files $uri $uri/ /index.html; }`（SPA）
  - `location ^~ /api/ { proxy_pass http://127.0.0.1:3001; ... }`
  - `location ^~ /uploads/ { proxy_pass http://127.0.0.1:3001; ... }`
  - `location = /health { proxy_pass http://127.0.0.1:3001/health; }`

### D. 仓库规范（已修复，务必保持）

- 已移除 `.npmrc` 中的 Windows `script-shell=...pwsh.exe`，避免在 Linux 构建时报错。
- 首次克隆采用稀疏/部分克隆并排除大文件：脚本内 `git sparse-checkout set '/*' ':(exclude)backend/src/uploads/videos/**'`。

### E. 常见现象与结论（本次问题复盘）

- 502/健康失败：发布窗口期 Nginx 先探测导致；现脚本已增加本地与域名健康重试与门禁，并在失败时自动回滚。
- 404 /api：站点 root 未指向 `current/dist` 或缺少 `/api` 反代；已在第九节与本节固定写法。
- 后端不监听/缺依赖：发布包内未带 `backend/node_modules` 或 PM2 cwd 错误；脚本已复制依赖并用正确 cwd 启动。


