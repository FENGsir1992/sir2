## 开发到发布的流程（本地 → GitHub → 服务器）

本文件说明如何从本地完成开发、推送到 GitHub，再在服务器一键发布与验证，确保本地/仓库/服务器三端一致。

### 前置约定
- 分支策略：以 `main` 为线上发布分支（服务器只部署 `main`）。
- Node 版本：20.x（推荐用 nvm 管理并锁定）。
- 服务器固定脚本：
  - 发布入口（带通知/健康门禁/自动回滚）：`/usr/local/bin/deploy-jr.sh`
  - 核心发布（无通知）：`/usr/local/bin/deploy-core.sh`
  - 拉取最新并发布：`/usr/local/bin/publish-latest.sh`
  - 回滚（上一成功版本，带健康重试）：`/usr/local/bin/rollback-jr.sh`
- 站点根目录（Nginx）：`/www/wwwroot/jr-app/current/dist`
- 共享资源目录：`/www/wwwroot/jr-app/shared/backend/{env.local, certs, uploads, logs, data}`

---

## 一、每次开发前（本地 Windows PowerShell）
```powershell
cd C:\Users\Administrator\Desktop\0\JR
git checkout main
git pull

# 建议在功能分支上开发
git checkout -b feat/v1.x-你的功能名
```

## 二、开发与本地自测（本地）
1) 编码实现...
2) 前端构建自测（可选）
```powershell
npm run build
```
3) 后端构建自测（可选）
```powershell
cd backend
npm run build
cd ..
```
4) 如有数据库变更：编写迁移（`backend/src/database/migrations/*.ts`）并在本地验证；服务器脚本会在发布时自动执行最新迁移。

## 三、合并回 main 并推送（本地）
```powershell
# 在分支上提交
git add -A
git commit -m "feat: v1.x 功能说明"

# 回到 main 并更新
git checkout main
git pull

# 合并分支（二选一）
# A. 快进合并（历史简单）
git merge --no-ff feat/v1.x-你的功能名
# B. rebase 后再合并（历史直线）
# git checkout feat/v1.x-你的功能名
# git rebase main
# git checkout main
# git merge --no-ff feat/v1.x-你的功能名

# 推送 main 到 GitHub（服务器从 main 拉取）
git push -u origin main

# 可选：打版本标签
# git tag v1.x.0
# git push origin v1.x.0
```

## 四、服务器发布（Linux）
方式一（推荐）：一键拉取并发布
```bash
/usr/local/bin/publish-latest.sh
```
方式二：仅发布（不拉取）
```bash
/usr/local/bin/deploy-jr.sh
```

说明（脚本行为）：
- 前端 `npm ci && npm run build`
- 后端 `npm ci && npm run build`（完整依赖以通过类型检查/编译）
- 将 `backend/node_modules` 与 `dist` 复制到发布包；切换 `current` 后在 `current/backend` 执行 `npm prune --omit=dev` 精简为运行时依赖
- 切换 `current` → PM2 正确 cwd 启动/重启 → `nginx -t && nginx -s reload`
- 健康门禁：先本地 `http://127.0.0.1:3001/health` 到 200，再对域名 `https://www.jiruikeji.top/health` 做最长约 120 秒重试；失败自动回滚到上一个成功版本
- 如配置 `JR_NOTIFY_URL` 与 `JR_NOTIFY_DING_SECRET`（钉钉加签），发布成功/失败/回滚会自动发送通知

## 五、发布后验证（服务器）
```bash
curl -k -I https://www.jiruikeji.top/health   # 期待 HTTP/2 200
```
浏览器验证页面与关键接口（列表/详情/登录/下单等）。

## 六、异常回滚（服务器）
```bash
/usr/local/bin/rollback-jr.sh
```
说明：回滚脚本会等待本地/域名健康 200（最长约 120 秒）。窗口期出现 000/502 属正常现象，脚本会自动重试直至健康或超时。

## 七、注意事项与最佳实践
- 只在 `main` 上发布：服务器脚本只拉取 `main`；开发走分支→合并回 `main`。
- 不要提交敏感/大文件：`.gitignore` 已包含 `.env`、`backend/data`、`uploads`、`dist` 等。
- 数据库变更：务必写迁移文件，避免“手改数据库”。
- Node 版本：本地与服务器都使用 Node 20.x（服务器已用 nvm 锁定）。
- 拉取过慢（服务器）：可临时设置镜像，脚本也会自动回退
```bash
export JR_REPO_MIRROR_URL=https://gitclone.com/github.com/FENGsir1992/sir2.git
```
- 钉钉通知：持久化在 `/etc/profile.d/jr-notify.sh`
```bash
export JR_NOTIFY_URL='https://oapi.dingtalk.com/robot/send?access_token=你的token'
export JR_NOTIFY_DING_SECRET='你的加签密钥'
```

## 八、冲突处理（本地）
pull/rebase 冲突时：
```powershell
# 解决冲突后
git add 发生冲突的文件...
git rebase --continue   # 如果是 rebase
# 或
git commit               # 如果是 merge
git push
```

## 九、常用命令速查
```bash
# 服务器：拉取最新并发布
/usr/local/bin/publish-latest.sh

# 服务器：仅发布（不拉取）
/usr/local/bin/deploy-jr.sh

# 服务器：回滚上一成功版本
/usr/local/bin/rollback-jr.sh

# 健康检查
curl -k -I https://www.jiruikeji.top/health
```



